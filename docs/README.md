# Документация CloudBridge Relay Client

## Обзор

CloudBridge Relay Client — это безопасный кроссплатформенный клиент для подключения к серверам CloudBridge Relay. Поддерживает TLS 1.3, аутентификацию через JWT/Keycloak, управление туннелями, heartbeat, ограничение скорости и устойчивую обработку ошибок.

---

## Архитектура

- **ConnectionManager**: Управляет защищёнными соединениями TLS 1.3 с relay-сервером.
- **AuthenticationManager**: Поддержка JWT (HS256) и опционально Keycloak (OpenID Connect).
- **TunnelManager**: Управление созданием, валидацией и жизненным циклом туннелей.
- **HeartbeatManager**: Контроль состояния соединения с помощью heartbeat.
- **ErrorHandler**: Централизованная обработка ошибок и логика повторов с экспоненциальным backoff.
- **Config**: Конфигурация на YAML, переопределяется через переменные окружения и CLI.

---

## Примеры использования

### Базовое подключение
```bash
cloudbridge-client --token "ваш-jwt-токен"
```

### С использованием конфигурационного файла
```bash
cloudbridge-client --config config.yaml --token "ваш-jwt-токен"
```

### Кастомный туннель
```bash
cloudbridge-client \
  --token "ваш-jwt-токен" \
  --tunnel-id "мой-туннель" \
  --local-port 3389 \
  --remote-host "192.168.1.100" \
  --remote-port 3389
```

---

## Параметры конфигурации

См. пример `config.yaml`. Все параметры можно задать через переменные окружения (префикс `CLOUDBRIDGE_`).

- **relay.host**: адрес relay-сервера
- **relay.port**: порт relay-сервера
- **relay.tls.enabled**: использовать TLS (должно быть true)
- **relay.tls.min_version**: только "1.3"
- **relay.tls.verify_cert**: проверять сертификат
- **relay.tls.ca_cert**: путь к CA-сертификату
- **auth.type**: "jwt" или "keycloak"
- **auth.secret**: секрет для JWT (HS256)
- **auth.keycloak.enabled**: включить интеграцию с Keycloak
- **rate_limiting.enabled**: включить ограничение скорости
- **rate_limiting.max_retries**: максимальное число повторов
- **rate_limiting.backoff_multiplier**: множитель экспоненциального backoff
- **rate_limiting.max_backoff**: максимальная длительность backoff

---

## Вопросы безопасности

- **TLS 1.3**: только безопасные шифры
- **Проверка сертификата**: строгая, опционально закрепление CA
- **JWT**: только HS256, проверка claim `sub`
- **Keycloak**: OpenID Connect, автоматическое обновление JWKS, проверка ролей
- **Ограничение скорости**: по пользователю (JWT subject), экспоненциальный backoff, логирование
- **Токены**: никогда не логируются и не хранятся в открытом виде
- **Аудит**: все операции логируются

---

## Обработка ошибок и диагностика

- **invalid_token**: проверьте валидность, подпись и срок действия JWT
- **rate_limit_exceeded**: слишком много запросов; клиент повторит с задержкой
- **connection_limit_reached**: превышено число соединений
- **server_unavailable**: сервер недоступен
- **invalid_tunnel_info**: проверьте параметры туннеля
- **unknown_message_type**: несовпадение протокола или ошибка

### Шаги для диагностики
- Включите подробное логирование (`--verbose`)
- Проверьте логи relay-сервера
- Проверьте TLS-сертификаты и CA
- Убедитесь, что секрет JWT совпадает с сервером
- Для Keycloak — проверьте realm, client_id и JWKS endpoint

---

## Критерии приёмки

- [x] TLS 1.3, строгие шифры
- [x] JWT-аутентификация с проверкой claim
- [x] Управление туннелями (создание, валидация, прокси)
- [x] Heartbeat и контроль соединения
- [x] Ограничение скорости и повторы
- [x] Полная обработка ошибок
- [x] Логирование и аудит
- [x] Конфигурируемость через YAML, env, CLI

---

## API и протокол

Все сообщения — JSON, UTF-8, без сжатия.

### Пример: Hello
```json
{"type": "hello", "version": "1.0", "features": ["tls", "heartbeat", "tunnel_info"]}
```

### Пример: Auth
```json
{"type": "auth", "token": "<jwt>"}
```

### Пример: Tunnel
```json
{"type": "tunnel_info", "tunnel_id": "tunnel_001", "local_port": 3389, "remote_host": "192.168.1.100", "remote_port": 3389}
```

### Пример: Heartbeat
```json
{"type": "heartbeat"}
```

### Пример: Ошибка
```json
{"type": "error", "code": "rate_limit_exceeded", "message": "Превышен лимит запросов для пользователя"}
```

---

## Тестирование

- Юнит-тесты: аутентификация, туннели, обработка ошибок, ограничение скорости
- Интеграция: полный цикл соединения, TLS, реальный relay-сервер
- Безопасность: проверка сертификатов, JWT, пентесты

---

## Развёртывание и поддержка

- См. основной README для инструкций по сборке и развёртыванию
- Для вопросов используйте GitHub issues
- По вопросам безопасности — контакты в основном README 
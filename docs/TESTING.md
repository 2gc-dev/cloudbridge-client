# Руководство по тестированию: CloudBridge Relay Client

## Юнит-тесты

### Запуск всех юнит-тестов
```bash
go test ./...
```

### Что тестировать
- Аутентификация (JWT, Keycloak)
- Создание и валидация туннелей
- Обработка ошибок (все коды ошибок)
- Ограничение скорости и логику повторов
- Менеджер heartbeat

### Пример: запуск тестов для конкретного пакета
```bash
go test ./pkg/auth
```

---

## Интеграционные тесты

### Полный цикл соединения
- Запустите тестовый relay-сервер (с TLS 1.3)
- Запустите клиент с валидным JWT-токеном
- Проверьте соединение, аутентификацию, создание туннеля, heartbeat

### TLS 1.3 Handshake
- Используйте `openssl s_client -connect relay.example.com:8080 -tls1_3` для проверки сервера
- Запустите клиент и проверьте успешное рукопожатие

### Реальный relay-сервер
- Разверните relay-сервер в тестовой среде
- Проверьте работу клиента end-to-end с реальными токенами и туннелями

---

## Тестирование безопасности

### Проверка сертификатов
- Тестируйте с валидными и невалидными CA-сертификатами
- Тестируйте с просроченными или отозванными сертификатами сервера

### Проверка JWT
- Тестируйте с валидными, просроченными и поддельными токенами
- Тестируйте с отсутствующим или невалидным claim `sub`

### Ограничение скорости
- Смоделируйте всплеск запросов для проверки лимитов
- Проверьте экспоненциальный backoff и логику повторов

### Пентесты
- Используйте инструменты (`nmap`, `sslscan`, скрипты) для поиска уязвимостей
- Пробуйте атаки replay, DoS, fuzzing протокола

---

## Диагностика неудачных тестов
- Используйте флаг `--verbose` для подробных логов
- Проверяйте логи на коды ошибок и stack trace
- См. `docs/TROUBLESHOOTING.md` для типовых проблем

---

## CI
- Интегрируйте `go test ./...` в ваш CI (GitHub Actions, GitLab CI и др.)
- Сборка должна падать при ошибках тестов

---

## Сообщение об ошибках
- Открывайте issue на GitHub с логами тестов и деталями окружения (не публикуйте секреты) 
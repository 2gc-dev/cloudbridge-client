# Тест-план: Проверка работы серверного клиента CloudBridge с Relay Server

## Цель
Проверить корректную работу серверного клиента CloudBridge с Relay Server v2.0, включая автоматическое согласование протокола, fallback, метрики, health-check и совместимость с legacy.

---

## 1. Подготовка окружения

1.1. **Собрать и развернуть серверный клиент**
- Собрать cloudbridge-client (`make build` или `go build ./cmd/cloudbridge-client`)
- Убедиться, что конфиг-файл корректно заполнен (`config.yaml`)
- Проверить наличие валидного JWT токена

1.2. **Запустить Relay Server**
- Убедиться, что relay сервер v2.0 запущен и доступен по нужному адресу/порту
- Проверить логи relay на отсутствие критических ошибок

1.3. **Открыть порты для теста**
- UDP и TCP порты для QUIC, HTTP/2, HTTP/1.1 должны быть открыты между клиентом и сервером

---

## 2. Базовые проверки подключения

2.1. **Успешное подключение**
- Запустить клиент: `./cloudbridge-client -config config.yaml -token <jwt>`
- Ожидать сообщение об успешном подключении и создании туннеля
- Проверить логи клиента и relay на handshake и auth

2.2. **Проверка fallback**
- Заблокировать UDP (например, через iptables)
- Перезапустить клиент
- Ожидать автоматический переход на HTTP/2 или HTTP/1.1
- Проверить логи: должно быть видно, что QUIC недоступен, выбран другой протокол

2.3. **Проверка legacy fallback**
- Заблокировать UDP и HTTP/2 (например, через iptables)
- Перезапустить клиент
- Ожидать автоматический переход на HTTP/1.1
- Проверить логи: fallback до HTTP/1.1

---

## 3. Проверка автоматического переключения протокола

3.1. **Имитировать деградацию канала**
- Запустить клиент с рабочим QUIC
- Во время работы заблокировать UDP
- Ожидать автоматическое переключение на HTTP/2 или HTTP/1.1 без остановки клиента
- Проверить логи: должно быть видно переключение

3.2. **Восстановление протокола**
- Разблокировать UDP
- Ожидать, что при новых соединениях клиент снова попробует QUIC

---

## 4. Проверка метрик и health-check

4.1. **Метрики**
- Перейти на http://localhost:9090/metrics
- Убедиться, что метрики клиента доступны (success/failure count, latency, protocol stats)

4.2. **Health-check**
- Перейти на http://localhost:9090/health
- Ожидать ответ OK

---

## 5. Проверка совместимости с legacy relay

5.1. **Запустить relay v1.0.0**
- Запустить старую версию relay
- Запустить клиент
- Ожидать успешное подключение (backward compatibility)
- Проверить, что handshake и auth проходят по старому протоколу

---

## 6. Проверка логирования и ошибок

6.1. **Проверить логи клиента**
- Ошибки подключения, handshake, auth, туннеля должны быть информативны
- В логах должны быть видны попытки fallback и переключения протокола

6.2. **Проверить логи relay**
- Должны фиксироваться все подключения, ошибки аутентификации, создание туннелей

---

## 7. Проверка стабильности

7.1. **Долгоживущие соединения**
- Оставить клиент и relay работать не менее 1 часа
- Проверить отсутствие утечек памяти, зависаний, падений

7.2. **Множественные переподключения**
- Несколько раз перезапустить клиент
- Проверить, что relay корректно обрабатывает повторные подключения

---

## 8. Проверка документации

8.1. **Проверить соответствие документации**
- Сравнить поведение клиента с описанным в `PROTOCOL_NEGOTIATION_GUIDE.md` и `README.md`
- Сообщить о любых расхождениях

---

## 9. Ожидаемый результат
- Клиент всегда выбирает оптимальный протокол
- Fallback работает прозрачно
- Метрики и health-check доступны
- Логирование подробное
- Нет сбоев при длительной работе
- Совместимость с relay v1.0.0 и v2.0

---

## 10. Что приложить к отчету
- Скриншоты/логи успешных и неуспешных подключений
- Скриншоты метрик и health-check
- Описание найденных багов или несоответствий

---

**Спасибо за тестирование!** 